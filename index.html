<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Split Bill Resto</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body class="bg-light">
    <div class="container my-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="text-center mb-3">Split Bill Resto</h4>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <input
                id="restoName"
                class="form-control"
                placeholder="Nama Resto"
              />
            </div>
            <div class="col-md-6">
              <input
                id="billDate"
                type="date"
                class="form-control"
              />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Orang</label>
            <input
              id="peopleInput"
              class="form-control"
              placeholder="A, B, C"
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Yang Membayar</label>
            <select
              id="payerSelect"
              class="form-select"
            ></select>
          </div>

          <div class="mb-3">
            <label class="form-label">Menu</label>
            <div id="menu"></div>
            <button
              class="btn btn-primary w-100 mt-2"
              onclick="addItem()"
            >
              + Tambah Menu
            </button>
          </div>

          <div class="mb-3">
            <label class="form-label">Adjustment</label>
            <div class="row g-2">
              <div class="col-12">
                <input
                  id="discountInput"
                  class="form-control"
                  placeholder="Diskon Total (Rp)"
                />
              </div>
              <div class="col-6">
                <input
                  id="taxInput"
                  class="form-control"
                  placeholder="Tax (Rp)"
                />
              </div>
              <div class="col-6">
                <input
                  id="serviceInput"
                  class="form-control"
                  placeholder="Service (Rp)"
                />
              </div>
            </div>
            <small
              id="adjustInfo"
              class="text-muted"
            ></small>
          </div>

          <button
            class="btn btn-success w-100 mb-3"
            onclick="processBill()"
          >
            Process Bill
          </button>

          <div
            id="afterProcess"
            class="d-none"
          >
            <h5 class="text-center mb-2">Settlement</h5>

            <div id="settlementArea">
              <div id="summary"></div>
            </div>

            <div class="d-grid gap-2 mt-3">
              <button
                class="btn btn-primary"
                onclick="saveSettlement()"
              >
                Save Settlement (JPEG)
              </button>
              <button
                class="btn btn-outline-danger"
                onclick="resetAll()"
              >
                Restart
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const menuDiv = document.getElementById("menu");
      const summaryDiv = document.getElementById("summary");
      const payerSelect = document.getElementById("payerSelect");
      const adjustInfo = document.getElementById("adjustInfo");
      const afterProcess = document.getElementById("afterProcess");

      billDate.value = new Date().toISOString().split("T")[0];

      const rupiah = (n) => "Rp " + n.toLocaleString("id-ID");
      const parseRp = (v) => Number(v.replace(/[^\d]/g, "")) || 0;

      const getPeople = () =>
        peopleInput.value
          .split(",")
          .map((p) => p.trim())
          .filter(Boolean)
          .sort();

      peopleInput.addEventListener("input", updatePeople);

      function updatePeople() {
        const people = getPeople();
        const prev = payerSelect.value;
        payerSelect.innerHTML = "";
        people.forEach((p) => {
          const o = document.createElement("option");
          o.value = o.textContent = p;
          payerSelect.appendChild(o);
        });
        if (people.includes(prev)) payerSelect.value = prev;

        document.querySelectorAll(".checkbox-group").forEach((group) => {
          const checked = [...group.querySelectorAll("input:checked")].map(
            (c) => c.value
          );
          group.innerHTML = "";
          people.forEach((p) => {
            const div = document.createElement("div");
            div.className = "form-check form-check-inline";
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = p;
            cb.className = "form-check-input";
            if (checked.includes(p)) cb.checked = true;
            const label = document.createElement("label");
            label.className = "form-check-label";
            label.textContent = p;
            div.append(cb, label);
            group.appendChild(div);
          });
        });
      }

      function addItem() {
        const row = document.createElement("div");
        row.className = "card mb-2";
        row.innerHTML = `
      <div class="card-body p-2">
        <div class="row g-2 align-items-center">
          <div class="col-md-5">
            <input class="form-control menu-name" placeholder="Nama menu">
          </div>
          <div class="col-4 col-md-2">
            <input type="number" class="form-control qty text-center" min="1" value="1">
          </div>
          <div class="col-6 col-md-3">
            <input class="form-control price text-start" placeholder="Rp">
          </div>
          <div class="col-2 col-md-2 text-end">
            <button class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">✕</button>
          </div>
        </div>
        <div class="checkbox-group mt-2"></div>
      </div>`;
        row.querySelector(".price").addEventListener("input", (e) => {
          e.target.value = rupiah(parseRp(e.target.value));
        });
        menuDiv.appendChild(row);
        updatePeople();
      }

      /* Formatting Input */
      [discountInput, taxInput, serviceInput].forEach((i) => {
        i.addEventListener("input", () => (i.value = rupiah(parseRp(i.value))));
      });

      function processBill() {
        const people = getPeople();
        const payer = payerSelect.value;
        if (!people.length || !payer) return alert("Lengkapi data");

        /* STEP 1 — read menu rows */
        let subtotalPerPerson = {};
        let detail = {};
        let gross = 0;

        people.forEach((p) => {
          subtotalPerPerson[p] = 0;
          detail[p] = [];
        });

        for (const row of document.querySelectorAll("#menu .card")) {
          const name = row.querySelector(".menu-name").value || "Menu";
          const qty = +row.querySelector(".qty").value;
          const price = parseRp(row.querySelector(".price").value);
          const eaters = [
            ...row.querySelectorAll("input[type=checkbox]:checked"),
          ].map((c) => c.value);

          if (!qty || !price || !eaters.length)
            return alert("Menu belum lengkap");

          const total = qty * price;
          gross += total;

          const share = total / eaters.length;
          eaters.forEach((p) => {
            subtotalPerPerson[p] += share;
            detail[p].push(`${name}: ${rupiah(Math.ceil(share))}`);
          });
        }

        /* STEP 2 — parse adjustments */
        const discount = parseRp(discountInput.value);
        const tax = parseRp(taxInput.value);
        const service = parseRp(serviceInput.value);

        const totalAdjustable = gross - discount; // base for % calculation

        adjustInfo.innerHTML = `Diskon ${rupiah(discount)} | Tax ${(
          (tax / totalAdjustable) *
          100
        ).toFixed(2)}% | Service ${((service / totalAdjustable) * 100).toFixed(
          2
        )}%`;

        /* STEP 3 — calculate proportional shares */
        let finalPerPerson = {};
        let html = `
      <div class="alert alert-secondary">
        <strong>${restoName.value || "Resto"}</strong><br>${billDate.value}
      </div>
    `;

        const grandTotal = gross + tax + service - discount;

        people.forEach((p) => {
          const ratio = subtotalPerPerson[p] / gross;

          const taxShare = ratio * tax;
          const serviceShare = ratio * service;
          const discountShare = ratio * discount;

          const total =
            subtotalPerPerson[p] + taxShare + serviceShare - discountShare;

          finalPerPerson[p] = Math.ceil(total);

          html += `
        <div class="card mb-2">
          <div class="card-body p-2">
            <strong>${p}</strong><br>
            <ul class="mb-0 mt-2">
              ${detail[p].map((d) => `<li>${d}</li>`).join("")}
            </ul>
            Subtotal: ${rupiah(Math.ceil(subtotalPerPerson[p]))}<br>
            Tax: ${rupiah(Math.ceil(taxShare))}<br>
            Service: ${rupiah(Math.ceil(serviceShare))}<br>
            Discount: -${rupiah(Math.ceil(discountShare))}<br>
            <hr class="my-2">
            <strong>Total: ${rupiah(finalPerPerson[p])}</strong>
          </div>
        </div>
      `;
        });

        /* STEP 4 — Settlement */
        html += `
      <hr>
      <h6>Settlement</h6>
      <div class="alert alert-info">Grand Total Bill: <strong>${rupiah(
        grandTotal
      )}</strong></div>
    `;

        people.forEach((p) => {
          if (p === payer) {
            html += `<div class="alert alert-success">${p} membayar ${rupiah(
              finalPerPerson[p]
            )} (dibayar sendiri)</div>`;
          } else {
            html += `<div class="alert alert-danger">${p} bayar ke ${payer}: ${rupiah(
              finalPerPerson[p]
            )}</div>`;
          }
        });

        summaryDiv.innerHTML = html;
        afterProcess.classList.remove("d-none");
      }

      function saveSettlement() {
        html2canvas(settlementArea, { backgroundColor: "#fff", scale: 2 }).then(
          (c) => {
            const a = document.createElement("a");
            a.download = `${restoName.value || "split"}-${billDate.value}.jpg`;
            a.href = c.toDataURL("image/jpeg", 0.95);
            a.click();
          }
        );
      }

      function resetAll() {
        location.reload();
      }

      addItem();
    </script>
    <footer>
      <h6 class="text-center mb-3 secondary">&copy;2025 Daikawesa</h6>
    </footer>
  </body>
</html>
